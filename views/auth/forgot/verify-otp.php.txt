<?php
require_once __DIR__ . '/../../../config/connection.php';

$BASE  = rtrim(dirname($_SERVER['SCRIPT_NAME']), '/\\') . '/';
$email = trim($_GET['email'] ?? $_POST['email'] ?? '');
$ok=false; $err=''; $done=false;

if ($_SERVER['REQUEST_METHOD']==='POST') {
  $email = trim($_POST['email'] ?? '');
  $code  = trim($_POST['code']  ?? '');
  $p1    = $_POST['password']   ?? '';
  $p2    = $_POST['confirm']    ?? '';

  if (!filter_var($email, FILTER_VALIDATE_EMAIL) || $code==='') {
    $err='Email + OTP code are required.';
  } elseif ($p1==='' || $p2==='' || $p1!==$p2 || strlen($p1)<8) {
    $err='Passwords must match and be at least 8 characters.';
  } else {
    $pdo = db();
    $st = $pdo->prepare("SELECT * FROM otp_codes WHERE email=? AND purpose='password_reset' AND used_at IS NULL ORDER BY id DESC LIMIT 1");
    $st->execute([$email]);
    $row = $st->fetch();

    if (!$row) {
      $err='Invalid or used code.';
    } elseif (new DateTime($row['expires_at']) < new DateTime()) {
      $err='Code expired.';
    } elseif (!password_verify($code, $row['code_hash'])) {
      $err='Incorrect code.';
    } else {
      // change password
      $pwd = password_hash($p1, PASSWORD_DEFAULT);
      $pdo->prepare("UPDATE users SET password=?, updated_at=NOW() WHERE email=?")->execute([$pwd,$email]);
      $pdo->prepare("UPDATE otp_codes SET used_at=NOW() WHERE id=?")->execute([$row['id']]);
      $done = true;
    }
  }
}
?>
<!doctype html><html><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Verify OTP</title>
<link rel="stylesheet" href="<?=$BASE?>assets/css/auth.css">
</head><body class="auth-simple">
  <div class="auth-card">
    <h3>Reset password (OTP)</h3>

    <?php if($done): ?>
      <div class="success-message show">Password changed. You can now <a href="<?=$BASE?>auth/login">login</a>.</div>
    <?php else: ?>
      <?php if($err): ?><div class="error-message show"><?=htmlspecialchars($err)?></div><?php endif;?>

      <form method="post">
        <div class="form-group">
          <label>Email</label>
          <input type="email" name="email" required value="<?=htmlspecialchars($email)?>">
        </div>
        <div class="form-group">
          <label>6-digit code</label>
          <input type="text" name="code" minlength="6" maxlength="6" required placeholder="123456" inputmode="numeric">
        </div>
        <div class="form-group">
          <label>New password</label>
          <input type="password" name="password" required minlength="8">
        </div>
        <div class="form-group">
          <label>Confirm password</label>
          <input type="password" name="confirm" required minlength="8">
        </div>
        <button class="btn btn-primary">Change password</button>
        <div class="auth-switch-link">
          <a href="<?=$BASE?>auth/forgot?email=<?=urlencode($email)?>">Resend code</a>
        </div>
      </form>
    <?php endif; ?>
  </div>
</body></html>
